<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PPV Manager</title>
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <header class="site-header">
    <nav class="nav-bar">
      <a href="index.html">Dashboard</a>
      <a href="ppv.html">PPV Manager</a>
      <a href="history.html">Message History</a>
      <a href="queue.html">Scheduled Queue</a>
    </nav>
  </header>
  <h1>PPV Manager</h1>
  <table class="form-table">
    <thead>
      <tr>
        <th>PPV #</th>
        <th>Description</th>
        <th>Price</th>
        <th>Day</th>
        <th>Time</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="ppvTableBody"></tbody>
  </table>
  <div class="mt-15">
    <div class="mb-8">
      <label>PPV Number: <input type="number" id="ppvNumber" class="form-input" /></label>
    </div>
    <div class="mb-8">
      <label>Description: <input type="text" id="description" class="form-input" /></label>
    </div>
    <div class="mb-8">
      <label>Price: <input type="number" id="price" min="0" step="0.01" class="form-input w-80" /></label>
    </div>
    <fieldset class="schedule-section mb-8">
      <legend>Scheduling</legend>
      <label>Send every:
        <select id="scheduleDay" class="form-input w-80">
          <option value="">--</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
          <option value="22">22</option>
          <option value="23">23</option>
          <option value="24">24</option>
          <option value="25">25</option>
          <option value="26">26</option>
          <option value="27">27</option>
          <option value="28">28</option>
          <option value="29">29</option>
          <option value="30">30</option>
          <option value="31">31</option>
        </select>
      </label>
      <label>Time: <input type="time" id="scheduleTime" class="form-input w-200" /> <span>(EST)</span></label>
    </fieldset>
    <div class="mb-8">
      <button id="loadVaultBtn" type="button" class="btn btn-primary">Load Vault Media</button>
      <div id="vaultMediaList" class="vault-media-list"></div>
    </div>
    <button id="saveBtn" type="button" class="btn btn-primary">Save PPV</button>
  </div>
  <script>
    async function fetchPpvs() {
      try {
        const res = await fetch('/api/ppv');
        if (!res.ok) return;
        const data = await res.json();
        renderPpvTable(data.ppvs || []);
      } catch (err) {
        console.error('Error fetching PPVs:', err);
      }
    }

    function renderPpvTable(ppvs) {
      const tbody = document.getElementById('ppvTableBody');
      tbody.innerHTML = '';
      for (const p of ppvs) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.ppv_number}</td><td>${p.description}</td><td>${p.price}</td><td>${p.scheduleDay ?? ''}</td><td>${p.scheduleTime ?? ''}</td><td><button class="btn btn-secondary" onclick="deletePpv(${p.id})">Delete</button></td>`;
        tbody.appendChild(tr);
      }
    }

    function linkPreviewInclude(includeCb, previewCb) {
      // Previewing a media item without including it would break the PPV message,
      // so keep the "Include" and "Preview" checkboxes in sync.
      includeCb.addEventListener('change', () => {
        if (!includeCb.checked) previewCb.checked = false;
      });
      previewCb.addEventListener('change', () => {
        if (previewCb.checked) includeCb.checked = true;
      });
    }

    async function loadVaultMedia() {
      try {
        const res = await fetch('/api/vault-media');
        if (!res.ok) return;
        const data = await res.json();
        const items = Array.isArray(data) ? data : (data.list || data.results || data.media || data.data || []);
        const container = document.getElementById('vaultMediaList');
        container.innerHTML = '';
        for (const m of items) {
          const div = document.createElement('div');
          div.className = 'media-item';

          const thumb = (m.preview && (m.preview.url || m.preview.src)) ||
                        (m.thumb && (m.thumb.url || m.thumb.src));
          if (thumb) {
            const img = document.createElement('img');
            img.src = thumb;
            div.appendChild(img);
          }

          const idSpan = document.createElement('span');
          idSpan.className = 'media-id';
          idSpan.textContent = 'ID: ' + m.id;
          div.appendChild(idSpan);

          const includeLabel = document.createElement('label');
          const mediaCb = document.createElement('input');
          mediaCb.type = 'checkbox';
          mediaCb.className = 'mediaCheckbox';
          mediaCb.value = m.id;
          includeLabel.appendChild(mediaCb);
          includeLabel.append(' Include');
          div.appendChild(includeLabel);

          const previewLabel = document.createElement('label');
          const previewCb = document.createElement('input');
          previewCb.type = 'checkbox';
          previewCb.className = 'previewCheckbox';
          previewCb.value = m.id;
          previewLabel.appendChild(previewCb);
          previewLabel.append(' Preview');
          div.appendChild(previewLabel);

          linkPreviewInclude(mediaCb, previewCb);

          container.appendChild(div);
        }
      } catch (err) {
        console.error('Error loading vault media:', err);
      }
    }

    async function savePpv() {
      const ppvNumber = parseInt(document.getElementById('ppvNumber').value, 10);
      const description = document.getElementById('description').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const mediaFiles = Array.from(document.querySelectorAll('.mediaCheckbox:checked')).map(cb => Number(cb.value));
      const previews = Array.from(document.querySelectorAll('.previewCheckbox:checked')).map(cb => Number(cb.value));
      const scheduleDayVal = document.getElementById('scheduleDay').value;
      const scheduleTime = document.getElementById('scheduleTime').value;
      const scheduleDay = scheduleDayVal ? parseInt(scheduleDayVal, 10) : null;
      try {
        const res = await fetch('/api/ppv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ppvNumber, description, price, mediaFiles, previews, scheduleDay, scheduleTime })
        });
        const result = await res.json();
        if (res.ok) {
          document.getElementById('ppvNumber').value = '';
          document.getElementById('description').value = '';
          document.getElementById('price').value = '';
          document.getElementById('scheduleDay').value = '';
          document.getElementById('scheduleTime').value = '';
          document.getElementById('vaultMediaList').innerHTML = '';
          fetchPpvs();
        } else {
          alert(result.error || 'Failed to save PPV');
        }
      } catch (err) {
        console.error('Error saving PPV:', err);
      }
    }

    async function deletePpv(id) {
      if (!confirm('Delete this PPV?')) return;
      try {
        const res = await fetch(`/api/ppv/${id}`, { method: 'DELETE' });
        if (res.ok) {
          fetchPpvs();
        } else {
          alert('Failed to delete PPV');
        }
      } catch (err) {
        console.error('Error deleting PPV:', err);
      }
    }

    document.getElementById('loadVaultBtn').addEventListener('click', loadVaultMedia);
    document.getElementById('saveBtn').addEventListener('click', savePpv);
    fetchPpvs();
  </script>
</body>
</html>
