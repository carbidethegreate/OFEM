<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PPV Manager</title>
  <link rel="stylesheet" href="css/app.css">
</head>
<body>
  <header class="site-header">
    <nav class="nav-bar">
      <a href="index.html">Dashboard</a>
      <a href="ppv.html">PPV Manager</a>
      <a href="history.html">Message History</a>
      <a href="queue.html">Scheduled Queue</a>
    </nav>
  </header>
  <h1>PPV Manager</h1>
  <table class="form-table">
    <thead>
      <tr>
        <th>PPV #</th>
        <th>Description</th>
        <th>Price</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="ppvTableBody"></tbody>
  </table>
  <div class="mt-15">
    <div class="mb-8">
      <label>PPV Number: <input type="number" id="ppvNumber" class="form-input" /></label>
    </div>
    <div class="mb-8">
      <label>Description: <input type="text" id="description" class="form-input" /></label>
    </div>
    <div class="mb-8">
      <label>Price: <input type="number" id="price" min="0" step="0.01" class="form-input w-80" /></label>
    </div>
    <div class="mb-8">
      <button id="loadVaultBtn" type="button" class="btn btn-primary">Load Vault Media</button>
      <div id="vaultMediaList" class="vault-media-list"></div>
    </div>
    <button id="saveBtn" type="button" class="btn btn-primary">Save PPV</button>
  </div>
  <script>
    async function fetchPpvs() {
      try {
        const res = await fetch('/api/ppv');
        if (!res.ok) return;
        const data = await res.json();
        renderPpvTable(data.ppvs || []);
      } catch (err) {
        console.error('Error fetching PPVs:', err);
      }
    }

    function renderPpvTable(ppvs) {
      const tbody = document.getElementById('ppvTableBody');
      tbody.innerHTML = '';
      for (const p of ppvs) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.ppv_number}</td><td>${p.description}</td><td>${p.price}</td><td><button class="btn btn-secondary" onclick="deletePpv(${p.id})">Delete</button></td>`;
        tbody.appendChild(tr);
      }
    }

    async function loadVaultMedia() {
      try {
        const res = await fetch('/api/vault-media');
        if (!res.ok) return;
        const data = await res.json();
        const items = Array.isArray(data) ? data : (data.list || data.results || data.media || data.data || []);
        const container = document.getElementById('vaultMediaList');
        container.innerHTML = '';
        for (const m of items) {
          const div = document.createElement('div');
          const mediaCb = document.createElement('input');
          mediaCb.type = 'checkbox';
          mediaCb.className = 'mediaCheckbox';
          mediaCb.value = m.id;
          div.appendChild(mediaCb);

          const previewCb = document.createElement('input');
          previewCb.type = 'checkbox';
          previewCb.className = 'previewCheckbox';
          previewCb.value = m.id;
          div.appendChild(previewCb);

          const span = document.createElement('span');
          span.textContent = 'Media ' + m.id;
          div.appendChild(span);

          const thumb = (m.preview && (m.preview.url || m.preview.src)) ||
                        (m.thumb && (m.thumb.url || m.thumb.src));
          if (thumb) {
            const img = document.createElement('img');
            img.src = thumb;
            img.width = 50;
            img.style.marginLeft = '5px';
            div.appendChild(img);
          }
          container.appendChild(div);
        }
      } catch (err) {
        console.error('Error loading vault media:', err);
      }
    }

    async function savePpv() {
      const ppvNumber = parseInt(document.getElementById('ppvNumber').value, 10);
      const description = document.getElementById('description').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const mediaFiles = Array.from(document.querySelectorAll('.mediaCheckbox:checked')).map(cb => Number(cb.value));
      const previews = Array.from(document.querySelectorAll('.previewCheckbox:checked')).map(cb => Number(cb.value));
      try {
        const res = await fetch('/api/ppv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ppvNumber, description, price, mediaFiles, previews })
        });
        const result = await res.json();
        if (res.ok) {
          document.getElementById('ppvNumber').value = '';
          document.getElementById('description').value = '';
          document.getElementById('price').value = '';
          document.getElementById('vaultMediaList').innerHTML = '';
          fetchPpvs();
        } else {
          alert(result.error || 'Failed to save PPV');
        }
      } catch (err) {
        console.error('Error saving PPV:', err);
      }
    }

    async function deletePpv(id) {
      if (!confirm('Delete this PPV?')) return;
      try {
        const res = await fetch(`/api/ppv/${id}`, { method: 'DELETE' });
        if (res.ok) {
          fetchPpvs();
        } else {
          alert('Failed to delete PPV');
        }
      } catch (err) {
        console.error('Error deleting PPV:', err);
      }
    }

    document.getElementById('loadVaultBtn').addEventListener('click', loadVaultMedia);
    document.getElementById('saveBtn').addEventListener('click', savePpv);
    fetchPpvs();
  </script>
</body>
</html>
