<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OFEM Bulk Uploads</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#drop-area { border: 2px dashed #ccc; border-radius: 10px; padding: 30px; text-align: center; color: #666; }
#gallery { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
.item { display: flex; align-items: flex-start; border: 1px solid #ddd; padding: 10px; gap: 10px; }
.item img { max-width: 200px; height: auto; }
.caption-input { flex: 1; height: 100px; }
.schedule-input { width: 200px; }
</style>
</head>
<body>
<h1>Bulk Image Upload</h1>
<p>Drag and drop images below or click to select files. After uploading, captions will be auto generated via ChatGPT.</p>
<div id="drop-area">
  <input type="file" id="fileElem" multiple accept="image/*" style="display:none;">
  <p>Drag & Drop Files Here</p>
  <button id="fileSelect">Select Files</button>
</div>
<div id="gallery"></div>
<button id="generateCaptions">Generate Captions</button>
<button id="schedulePosts">Schedule Posts</button>

<script>
// Basic drag-and-drop handling
const dropArea = document.getElementById('drop-area');
const fileElem = document.getElementById('fileElem');
const fileSelect = document.getElementById('fileSelect');
const gallery = document.getElementById('gallery');
let filesToUpload = [];

fileSelect.addEventListener('click', () => fileElem.click());

fileElem.addEventListener('change', handleFiles, false);
dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.classList.add('hover');
});
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('hover'));
dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.classList.remove('hover');
  handleFiles({ target: { files: e.dataTransfer.files } });
});

function handleFiles(event) {
  const files = event.target.files;
  for (const file of files) {
    if (!file.type.startsWith('image/')) continue;
    filesToUpload.push(file);
    const reader = new FileReader();
    reader.onload = (e) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <img src="${e.target.result}" alt="${file.name}">
        <textarea class="caption-input" placeholder="Caption for ${file.name}"></textarea>
        <input class="schedule-input" placeholder="Schedule date/time" disabled>
      `;
      gallery.appendChild(div);
    };
    reader.readAsDataURL(file);
  }
}

let scheduleData = [];

document.getElementById('generateCaptions').addEventListener('click', async () => {
  if (filesToUpload.length === 0) {
    alert('Please select images first.');
    return;
  }
  const formData = new FormData();
  filesToUpload.forEach((file) => formData.append('images', file));

  try {
    const response = await fetch('/api/bulk-upload', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    if (data.error) {
      alert('Failed to generate captions');
      return;
    }
    const captionInputs = document.querySelectorAll('.caption-input');
    const scheduleInputs = document.querySelectorAll('.schedule-input');
    data.captions.forEach((c, idx) => {
      captionInputs[idx].value = c.caption;
    });
    scheduleData = data.schedule;
    data.schedule.forEach((s, idx) => {
      const dateObj = new Date(s.sendAt);
      scheduleInputs[idx].value = dateObj.toLocaleString();
    });
    alert('Captions generated.');
  } catch (err) {
    console.error(err);
    alert('Failed to generate captions');
  }
});

document.getElementById('schedulePosts').addEventListener('click', async () => {
  if (!scheduleData || scheduleData.length === 0) {
    alert('Please generate captions first.');
    return;
  }
  try {
    await Promise.all(scheduleData.map(item =>
      fetch('/api/scheduleMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: item.filename,
          message: item.caption,
          sendAt: item.sendAt
        })
      })
    ));
    alert('Posts scheduled!');
  } catch (err) {
    console.error(err);
    alert('Failed to schedule posts');
  }
});
<script>
document.getElementById('schedulePosts').addEventListener('click', () => {
  const items = document.querySelectorAll('#gallery .item');
  const scheduled = JSON.parse(localStorage.getItem('scheduledPosts') || '[]');
  items.forEach(item => {
    const imgEl = item.querySelector('img');
    const captionEl = item.querySelector('.caption-input');
    const dateInput = item.querySelector('.schedule-input');
    scheduled.push({
      image: imgEl ? imgEl.src : '',
      caption: captionEl ? captionEl.value : '',
      date: dateInput ? dateInput.value : '',      status: 'pending'
    });
  });
  localStorage.setItem('scheduledPosts', JSON.stringify(scheduled));
});
</script>
</script>
</body>
</html>
