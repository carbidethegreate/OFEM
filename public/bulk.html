<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OFEM Bulk Uploads</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#drop-area { border: 2px dashed #ccc; border-radius: 10px; padding: 30px; text-align: center; color: #666; }
#gallery { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
.item { display: grid; grid-template-columns: 24px 200px 1fr; align-items: flex-start; border: 1px solid #ddd; padding: 10px; gap: 10px; border-radius: 6px; }
.item img { max-width: 200px; height: auto; border-radius: 4px; }
.item .checkbox-cell { display: flex; align-items: center; justify-content: center; padding-top: 6px; }
.caption-input { width: 100%; height: 100px; resize: vertical; }
.schedule-input { width: 210px; }
.schedule-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 6px; }
.destination-group { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.destination-pill { border: 1px solid #ccc; padding: 6px 10px; border-radius: 999px; cursor: pointer; background: #f9f9f9; display: inline-flex; align-items: center; gap: 6px; }
.destination-pill input { display: none; }
.destination-pill.active { border-color: #007bff; background: #e7f1ff; color: #004085; font-weight: 600; }
.upload-status { font-size: 12px; color: #444; margin-top: 6px; }
.upload-status .error { color: #c00; font-weight: 600; }
.upload-status .schedule-status { margin-top: 4px; display: block; }
.upload-status .reupload-status { display: block; margin-top: 2px; }
.upload-status .send-status { display: block; margin-top: 2px; }
.status-banner { margin-top: 10px; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background: #f7f7f7; }
.status-info { border-color: #ccc; color: #333; background: #f7f7f7; }
.status-success { border-color: #5cb85c; color: #2f6627; background: #edf7ed; }
.status-warning { border-color: #f0ad4e; color: #8a6d3b; background: #fdf7e3; }
.status-error { border-color: #d9534f; color: #a94442; background: #f9e2e2; }
.hidden { display: none; }
.toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0; align-items: center; }
.toolbar .spacer { flex: 1; min-width: 10px; }
.schedule-tools { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
.schedule-tools label { font-size: 14px; color: #333; }
.schedule-tools input[type="number"],
.schedule-tools select { padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc; }
.timezone-select { min-width: 200px; }
.helper-text { font-size: 12px; color: #666; }
.item-body { display: flex; flex-direction: column; gap: 6px; width: 100%; }
.badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #eef2ff; color: #334155; font-size: 11px; margin-left: 4px; }
.actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
.send-button { background: #0d6efd; color: #fff; border: 1px solid #0a58ca; padding: 8px 10px; border-radius: 4px; cursor: pointer; }
.send-button:disabled { opacity: 0.6; cursor: not-allowed; }
.pill-note { font-size: 12px; color: #555; margin-top: 2px; }
</style>
</head>
<body>
<h1>Bulk Image Upload</h1>
<p>Drag and drop images below or click to select files. After uploading, captions will be auto generated via ChatGPT.</p>
<div id="drop-area">
  <input type="file" id="fileElem" multiple accept="image/*" style="display:none;">
  <p>Drag & Drop Files Here</p>
  <button id="fileSelect">Select Files</button>
</div>
<div class="toolbar">
  <div class="schedule-tools">
    <label>
      Start
      <input type="datetime-local" id="staggerStart">
    </label>
    <label>
      Interval (minutes)
      <input type="number" id="staggerInterval" min="1" value="15">
    </label>
    <label>
      Timezone
      <select id="defaultTimezone" class="timezone-select"></select>
    </label>
    <button id="applyStagger">Auto-stagger</button>
    <div class="helper-text">Fills empty times using the interval; manual times stay untouched.</div>
  </div>
  <div class="spacer"></div>
  <div class="actions">
    <button id="generateCaptions">Generate Captions</button>
    <button id="retryUploads" class="hidden">Retry Failed Uploads</button>
    <button id="schedulePosts">Schedule</button>
    <button id="sendSelected" class="send-button" disabled>Send selected to OnlyFans queue</button>
  </div>
</div>
<div id="gallery"></div>
<div id="statusMessage" role="status"></div>

<script>
// Basic drag-and-drop handling
const dropArea = document.getElementById('drop-area');
const fileElem = document.getElementById('fileElem');
const fileSelect = document.getElementById('fileSelect');
const gallery = document.getElementById('gallery');
const statusMessage = document.getElementById('statusMessage');
const retryUploadsButton = document.getElementById('retryUploads');
const scheduleButton = document.getElementById('schedulePosts');
const sendSelectedButton = document.getElementById('sendSelected');
const staggerStartInput = document.getElementById('staggerStart');
const staggerIntervalInput = document.getElementById('staggerInterval');
const defaultTimezoneSelect = document.getElementById('defaultTimezone');
const applyStaggerButton = document.getElementById('applyStagger');
let filesToUpload = [];
const LOCAL_STORAGE_KEYS = {
  timezone: 'ofem.bulk.timezone',
  intervalMinutes: 'ofem.bulk.staggerMinutes',
};

function setStatusMessage(message, tone = 'info') {
  statusMessage.textContent = message;
  statusMessage.className = `status-banner status-${tone}`;
}

function getSavedTimezone() {
  return localStorage.getItem(LOCAL_STORAGE_KEYS.timezone) || null;
}

function getDefaultTimezone() {
  return (
    getSavedTimezone() ||
    (Intl?.DateTimeFormat?.().resolvedOptions?.().timeZone || 'UTC')
  );
}

function saveTimezone(tz) {
  if (tz) {
    localStorage.setItem(LOCAL_STORAGE_KEYS.timezone, tz);
  }
}

function saveInterval(minutes) {
  if (Number.isFinite(minutes) && minutes > 0) {
    localStorage.setItem(LOCAL_STORAGE_KEYS.intervalMinutes, String(minutes));
  }
}

function getSavedInterval() {
  const value = parseInt(localStorage.getItem(LOCAL_STORAGE_KEYS.intervalMinutes), 10);
  return Number.isFinite(value) && value > 0 ? value : null;
}

function getTimezoneOptions() {
  try {
    if (typeof Intl.supportedValuesOf === 'function') {
      return Intl.supportedValuesOf('timeZone');
    }
  } catch (err) {
    // ignore
  }
  return [getDefaultTimezone()];
}

function toDateTimeLocalValue(dateInput) {
  if (!dateInput) return '';
  const parsed = new Date(dateInput);
  if (Number.isNaN(parsed.getTime())) return '';
  const local = new Date(parsed.getTime() - parsed.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0, 16);
}

document.addEventListener('DOMContentLoaded', () => {
  const tzs = getTimezoneOptions();
  defaultTimezoneSelect.innerHTML = '';
  tzs.forEach((tz) => {
    const opt = document.createElement('option');
    opt.value = tz;
    opt.textContent = tz;
    defaultTimezoneSelect.appendChild(opt);
  });
  defaultTimezoneSelect.value = getDefaultTimezone();

  const savedInterval = getSavedInterval();
  if (savedInterval) staggerIntervalInput.value = savedInterval;

  defaultTimezoneSelect.addEventListener('change', (e) => saveTimezone(e.target.value));
  staggerIntervalInput.addEventListener('change', (e) => {
    const v = parseInt(e.target.value, 10);
    if (Number.isFinite(v) && v > 0) saveInterval(v);
  });

  const now = new Date();
  staggerStartInput.value = toDateTimeLocalValue(now);
});

function createDestinationPills(name, defaultValue = 'both') {
  const container = document.createElement('div');
  container.className = 'destination-group';
  const options = [
    { label: 'Post', value: 'post' },
    { label: 'Message', value: 'message' },
    { label: 'Post + Message', value: 'both' },
  ];

  options.forEach((opt) => {
    const pill = document.createElement('label');
    pill.className = 'destination-pill';
    pill.dataset.value = opt.value;

    const input = document.createElement('input');
    input.type = 'radio';
    input.name = name;
    input.value = opt.value;

    if (opt.value === defaultValue) {
      input.checked = true;
      pill.classList.add('active');
    }

    const span = document.createElement('span');
    span.textContent = opt.label;

    pill.appendChild(input);
    pill.appendChild(span);

    pill.addEventListener('click', () => {
      [...container.querySelectorAll('.destination-pill')].forEach((p) => p.classList.remove('active'));
      pill.classList.add('active');
      input.checked = true;
    });

    container.appendChild(pill);
  });

  const note = document.createElement('div');
  note.className = 'pill-note';
  note.textContent = 'Choose where to send this item.';
  container.appendChild(note);

  return container;
}

function setDestinationValue(container, value) {
  const pills = container.querySelectorAll('.destination-pill');
  pills.forEach((pill) => {
    const isActive = pill.dataset.value === value;
    pill.classList.toggle('active', isActive);
    const input = pill.querySelector('input');
    if (input) input.checked = isActive;
  });
}

function getDestinationValue(container) {
  const active = container.querySelector('.destination-pill.active');
  if (active?.dataset?.value) return active.dataset.value;
  const checked = container.querySelector('input[type="radio"]:checked');
  return checked?.value || 'both';
}

function updateSendButtonState() {
  const items = Array.from(document.querySelectorAll('#gallery .item'));
  const hasChecked = items.some((item) => {
    const checkbox = item.querySelector('.select-item');
    return checkbox?.checked;
  });
  sendSelectedButton.disabled = !hasChecked;
}

fileSelect.addEventListener('click', () => fileElem.click());
fileElem.addEventListener('change', (e) => {
  if (e.target?.files) handleFiles(e.target.files);
});
['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
  dropArea.addEventListener(eventName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (eventName === 'dragenter' || eventName === 'dragover') dropArea.classList.add('hover');
    if (eventName === 'dragleave' || eventName === 'drop') dropArea.classList.remove('hover');
  });
});
dropArea.addEventListener('drop', (e) => {
  if (e.dataTransfer?.files) handleFiles(e.dataTransfer.files);
});

function handleFiles(fileList) {
  const files = Array.from(fileList).filter((f) => f.type.startsWith('image/'));
  if (!files.length) {
    setStatusMessage('No image files detected.', 'warning');
    return;
  }
  filesToUpload.push(...files);
  setStatusMessage(`${files.length} file(s) added.`, 'info');
  renderGallery(files);
  updateSendButtonState();
}

function renderGallery(newFiles) {
  newFiles.forEach((file, idx) => {
    const url = URL.createObjectURL(file);
    const item = document.createElement('div');
    item.className = 'item';
    const checkboxCell = document.createElement('div');
    checkboxCell.className = 'checkbox-cell';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'select-item';
    checkbox.checked = true;
    checkbox.addEventListener('change', updateSendButtonState);
    checkboxCell.appendChild(checkbox);
    const img = document.createElement('img');
    img.src = url;
    img.alt = file.name;
    const body = document.createElement('div');
    body.className = 'item-body';
    const nameBadge = document.createElement('div');
    nameBadge.innerHTML = `${file.name} <span class="badge">${Math.round(file.size / 1024)} KB</span>`;
    const caption = document.createElement('textarea');
    caption.className = 'caption-input';
    caption.placeholder = 'Caption will be generated...';
    const scheduleRow = document.createElement('div');
    scheduleRow.className = 'schedule-row';
    const scheduleInput = document.createElement('input');
    scheduleInput.type = 'datetime-local';
    scheduleInput.className = 'schedule-input';
    scheduleRow.appendChild(scheduleInput);
    const destGroup = createDestinationPills(`destination-${Date.now()}-${idx}`, 'both');
    const destNote = document.createElement('div');
    destNote.className = 'pill-note';
    destNote.textContent = 'Destination applies when sending to OnlyFans.';
    body.appendChild(nameBadge);
    body.appendChild(caption);
    body.appendChild(scheduleRow);
    body.appendChild(destGroup);
    body.appendChild(destNote);
    item.appendChild(checkboxCell);
    item.appendChild(img);
    item.appendChild(body);
    gallery.appendChild(item);
  });
}

defaultTimezoneSelect.addEventListener('change', () => {
  const tz = defaultTimezoneSelect.value;
  if (tz) {
    saveTimezone(tz);
    document.querySelectorAll('#gallery .timezone-select').forEach((select) => {
      select.value = tz;
    });
  }
});

staggerIntervalInput.addEventListener('change', () => {
  const minutes = parseInt(staggerIntervalInput.value, 10);
  if (Number.isFinite(minutes) && minutes > 0) {
    saveInterval(minutes);
  }
});

applyStaggerButton.addEventListener('click', () => {
  const startVal = staggerStartInput.value;
  const intervalMin = parseInt(staggerIntervalInput.value, 10);
  if (!startVal || !Number.isFinite(intervalMin) || intervalMin <= 0) {
    setStatusMessage('Please set a valid start time and interval.', 'warning');
    return;
  }
  const items = [...gallery.querySelectorAll('.item')];
  let cursor = new Date(startVal);
  let changed = 0;
  items.forEach((item, i) => {
    const input = item.querySelector('.schedule-input');
    if (!input.value) {
      input.value = toDateTimeLocalValue(cursor);
      changed++;
      cursor = new Date(cursor.getTime() + intervalMin * 60000);
    }
  });
  setStatusMessage(changed ? `Filled ${changed} empty time(s).` : 'No empty schedule fields to fill.', 'info');
});

scheduleButton.addEventListener('click', () => {
  const selected = [...gallery.querySelectorAll('.item')].filter((i) => i.querySelector('.checkbox-cell input').checked);
  if (!selected.length) {
    setStatusMessage('Select at least one item to schedule.', 'warning');
    return;
  }
  setStatusMessage(`Prepared ${selected.length} item(s) for scheduling.`, 'success');
});

sendSelectedButton.addEventListener('click', () => {
  const selected = [...gallery.querySelectorAll('.item')].filter((i) => i.querySelector('.checkbox-cell input').checked);
  if (!selected.length) {
    setStatusMessage('Select at least one item to send.', 'warning');
    return;
  }
  setStatusMessage(`Ready to upload ${selected.length} item(s) to OnlyFans queue.`, 'success');
});
</script>
</body>
</html>
